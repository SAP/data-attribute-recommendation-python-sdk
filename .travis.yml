# Explore and validate the config here:
# https://config.travis-ci.com/explore

cache:
  directories:
  - "$HOME/.cache/pre-commit"

# For the conditionals below: the `branch` corresponds to the base branches:
# for PRs. See https://docs.travis-ci.com/user/conditions-v1 for details.

# Only build on master OR for PRs. Otherwise, we will run the same tests twice: once
# for the PR, once for the branch.
# If your builds do not start when you expect them to start, go here to understand why:
# https://travis-ci.com/github/SAP/data-attribute-recommendation-python-sdk/requests
if: branch = master OR tag =~ ^rel/.*$ OR type != push

os: linux
dist: xenial

notifications:
  email:
    if: branch = master AND type != pull_request
    on_failure: always
    recipients:
      # Michael
      - secure: "r05MU3AGjL+KMQSy3s3PW2tm3qA/ElRKQalMuixr3a1EJr6ZOb+FV2jRWM25q/2x5U/yszigtAKDuuF/Y/gbpIp4UwfhF9iTi7INF05F32E2SZAjnxA7rWJU294CR51J9UOYCaYt0fWPEt0IZMXl5rp1ORarNgLB2m33ZZKVzTr2ArSVBh/TvduymK1nEwTuA148fPQXobMCM6NF5qyVmxaoRWVQPVqafpmjSum+1k5qcZVFOHrix9hKFgJNZ/BrQu3w7lpu1HWpVoSr8wf1ZOt5VIeNL8NZBNM6vIQxdlOWpm9/ooTW/oKCuYuKs4aLp/AwJsrwJdYAls7TobyRlUh0u7HXj5+S4+BadlxgpKLWEV7KEPYgpIFvHEv2rcQUFQY7K4j+9U7wr4uxqUUaSvykYlipu+50pJshZjxKjx6frRFojjeaJNGmsL6ekK5ADrEWvbdhsnMG5SMbbWKrX9TFHv/HOwZuCQMsX/Noqnicxy0jt0PxTNsSRmlbIhw4pCGqcQmOA3LPOz3s9YiZZLxR2KmhLITCTRJKVKUbo0f1ctEGf6bOa5da3CDVAIvNpUsIjg37wJGMh/rp3ZoCs4J+ecmulfHqKmcx2P6x2uBqgAaGh7CmL2rlOe5F4WBOJQUvej6KJzcbkI1D7zyKXLk2ogKmQKd4vKsw6vxVFu0="
      # Karthik
      - secure: "OmT4gL0Z4GLC6tZNHQjJzfVQjFsBzWKp1oGnIzW0kClIUiq8gJU6i17M+pMsAondUOn7ALoFxfyFEdtwPfDgGt9pfoO/kHR4fIdldk+v5N4gOSNGDfiso0FGCXgaD3A1JG3kEG4ODv0JShh6KpRi8YwMv0BASyOG9nQwLQu6s5bNzyBnbnAQhQwGx+dzNxA1JWNPx4+EgWArzhdFmfq1/haqMqS6X9Sv1fEnQPH5dsRbTm5+kULqurSbSJ7wxuVnnJgGhc8XWFTZArLlrtxTe4ykfGMu6Rm2PUWw0y80IGZ7DY3C3wloPtBSvF+uO8y/H6ha+eyrF07+roh1l9uWlUVJ8lkn0o0SWKT0/K1tS34JK+oDxQzQWmkJYTR5RdXx6/4f2C/oueZtb8SBSpYxtDrzGBGixIU8lRmcX9x8knA6Tl5fOUlw4MHOqTGTV/oMTgpvaOXN0jGxNWPv0Ud3lMuyD7sgSihdwlFO5rASq0SSqPg4oHogMM/dMW6D5v6/Q3tuMc8hSo9rR9DNws7ktz84Y8TAdrkGWM+jem+ihwzKAjW/ExEbSZzoco8LLqxRtsCmY2Sl21VHGUzbglSvoQfcYhpra//9GLzxyHPZORrdRTMEKBT3SeJgvSb83RNA0Vz1OOzw/JN1JUwQQClrfeGDk6qQuZutbHFYEqvT9TE="
      # Francesco
      - secure: "grK5n7UwWsw7W/e/MJNh7oMfJgEqocQ4iI9Bc5SD85/eGs8QtyO1wqwt3VZ56LHolbcdojT1arNyrgGZW4z5VLaaAtX5y3Beh286eNv4o8mifGwRoK9UC0nZNTwX0c6zy2A9QGzRAsVAqxcDJIPSEN3Gw+zkU+b8MihO2K5eQnPJRTaOPGf1ZZpDfhwfTHvfWPwxj8qu4z/wcCy4UlYK1C0+ikyH6UInlnVeLLALnu/U6/iN7POvWHaeSaBYrQMB+aFhzEfRY2N3LVRHtbP+TGm5Q+KcGH1cd38axAvN0lLNXpUEvla5d/VjINuCV9R6Nh9JxqmnwSOOh4b1RT15/MA1CnrI9okEMNISBjlED8oVTTA7UQtPhdH9QGhUIkc45yt83mcfdq57JQOUq8lw72NzI0lJ5sIPfDn2H/ucuMVOSkpYmee6hjprpZvyIKD6JjKsq56PjNsFt6wvLhA+O5/bpAXDQVbJIa9ww3veDwFoD9pvtNfc0ocxBz+4C07zZ0kDxNgFHY+N5XY+k8cqoXKSYeMbKggxa6FnffVh2oBvlzOnBRZJOKJBTjPtF2qonzQjJyA5KtJQuQ9xO5a56xbyuNufsJT7vFNWrGzqw0YqWcQnMLWwerdHTKWu0ovaQd3mjtAbm1WvN33d1KPY3YFWoQU6YITwpCi4MjxsJVU="
      # Evgeny
      - secure: "Ul1D1qkD16wpcuHu+k3qjaHPbeN9oUnofvBJ4OCVMpC4jADtRsuwSKm1gpTApXCoE/scVm2y4qBmwppvzH+m7KQmX1j9T1Al23/KVKUWv241K0pH/MMvF0PFiRIveCG5jwYhAP9KPfYN1zKfmO490zeHp7zRAwWa5fIpx3Ic2WVBLxkU0QNzPZ9ZFWzVPnsP9Mw/QInN1ZQ5lPBdjRe+XOUKR27OiZuYL4mrzBWxkUDn7T8avouYBeYpfqOyLRGegc9C9z1Qz1wkjWBvoAlAy+qt0FwkYE/NdiwAiuircVxw+ASSkfH1lnq4z93HEIfE5jSYomwjGU6LrryMBnn06kmGH0BCG8WHSEuaqTtG+G3Ys2VcPh3erdRXRYSssP6spVgmyOy9z25+snWyrOyiLjr6/ojOWRkjqnnnh1Dqslvsvd8CzmtGTi0F3UjruRezn1K7FmniDx82Po2VWOd1BtoQlmGtSN20ckyOfz8piY1tEmWJ5AllUVPnB5AvEwimYsmZ6bpbWb0k4z9hjdrFivZrzVIT029mzhDB5sALn3xlMXp8P9/v3JznTvNZryYKHG+H5YwuiNVw7Vc+h/VOZCtu1aldX97y5VOgl0SL3Zjo+sYA4te31FGUxwt+MtoTjYfLZtgejmRHcgpMJaJRWHyDMe4Ol4Gmrb6jKKX1GJc="


stages:
- name: linting
- name: test
- name: "system tests"
  if:  type != pull_request AND (branch = master OR tag =~ ^rel/.*$)
# Note that deployment of the traceability report to github happens in the system
# tests stage above, with an additional condition to only execute on tag =~ ^rel/.*$.
# For technical reasons, the upload to pypi is a separate stage: the pypi upload does
# not work from a windows environment
- name: deploy
  if: type != pull_request AND tag =~ ^rel/.*$

language: python
install:
- pip3 install -r requirements-test.txt
script: tox

env:
    global:
      # DAR_CLIENT_ID
      - secure: "UrSYKHy+I/UZMO9tQFfLCcOMVuG5zWd4DnpUp78/aQ2rkogws49x8WEkYCse89lMYCdbwtHCEvHKQ9BlJdV9hY9Tw1kSprY6CRNJwQyfpWJVmMCSPkiXTdfI2+/oL4jkhsrLK28ZFT/Q/dItDBbNmtv9YSpQBb5gU9R0mRmSII/R1Pmps5wvncNipBD78A9/lsJAp6ag8jJWfVLgwmDQxBpfEh2j1vL/9kzcXdgt3rAR/8gFy+CuynFs5ZDFkcGfsPjj38M21R0zg5jR5FbVqccke2h3eQ98EjvKRcscaAQGoDfeSemRE/r3c9OKoH2jnzMN49KzFmwArz0u+yi0qpW0GW3+C7B88ex8dGaHY7vXjJ6SLbPx6xchACAZerBParsqGpTUJFUfXHNhFD64w6lRyWAVuvmRIE9RbkSBFQIiSpHaiOenP+JHcII0sZbr86L+Lo59xPAGktHwrKxYbnM51juJm927/ITors1WXn9f3V0V4C+pST8I8hGGFrbA0cTHuQyhQgSBPy12uHlX0LZQYfKSt3nQKgclllYonnEC3G1wrMXj3xufIh3M0O9a1GoD3U0S2NzrOKRIuVGBdwjqjKme4iJ/3epbf+d8IXBryvwJFgf5T98OVkhr/KcfHo2DBw+7yQ/y4jRf+D5/xqkKBRBV7andbVf43k6tt7g="
      # DAR_CLIENT_SECRET
      - secure: "cvvfl3dzAuHu5xfcdhSpobOZ4sj4ciKUzPdXTGLCk2lvhl4w08iLyl8MEz+gcRhQYfx2GwTY7QrNAKJxFhW170Uoc6PCg6zMdioHJT55mUo81SZ+cJd+pNWB5cbiTctI7cSG3y+jTjp7QpmLRA0GtrG0TMX3fAVAcXF0cR970X68Vrl9bDYe8cZJvYhkWdxfN1M093/FJ9L1wR9817atL2HrWhlCgkxSaFy+6nIF5RfqCqLxTc5BWoHwm5R/rbx3JrCRhAQZxay8nbnEYRXaIM42jYae0YYWYRTnboYGWtcxwwPey4W71sPTpHfvfS7gPG6dzOEg2JpDujRTcKhzKcsRsqFwWUrg0HUsQZOWvovMP/MIZ8uOQoaDoxHaV8HnT+JHdPcE9RetDqps8WODTpDek2gUTYB7gQeFpBCEW0CF59VWHX6nJrVan0iX/5rFUIYzNkBHtV+grlaXavC2jZ4LojUApM1kMg9ciZxgEr85cQ5H8MhfZLv7mS/T3ZsLr703d+0JGTHos5R18IHN0/MhHHYHo8jWZu02hg7RQU/PQ/jsBJCc178pxY9L1I6fp2HLYJyG9G+3vfMC31soeMB/OqC6r+wPXFH/9a36kwKBN13ad/0a6RXHTUmNOnKwpJLiO2aRi+jCKy78otQwbezz6OMpLN4Ft/+QXcElmmY="
      # DAR_AUTH_URL
      - secure: "bK/Pv9kJWf7GloYFVoNPs4wyx7tDe8TqMHy5VpHFCdMbxPJ9Dn8eH6YmhwYGBsTdkFPU20oQ9dRo7p8VIFKRH84YXoKljawu3Yb97Y3W8k74twWojnoSboiTorinYf46ujJtnuT6Og3r8UPC9eUdjI7jcziOBX3UhmSmCGmjT1P0UvHcgz48eYAJToVZj2/GseDEO7T14nppIGocD4+M6eFbSArDty2GSxjQwm9Xvpbm47KftkRtnTOr4hM1QlD+H+Fo6RBLvBZI10Yhrq59tYph9OvvORFALRWP05DXsQRot5MA/xmtADkAJMN9FcC/XjI7k4zuoPHgy0Uw9Oapfgorfr/fKLd+zFQTAkQeLSHEyv44nflfKjQa/w+cALxRS6JZ+tVmh1ULj4Qo/wR1Dwt4sypL1y7IqOJnC7PjrJmf60jQgkKDtVQVJ0okwz+voZAqlOZFisDbcbIl+NU86TdBZJRQik2YZ94F7LVPy4VEqEKERGqaC83KDhqFgAI8ErNKf+DQKdCugbZXSYMW7tXBokAe9GjXnad8sRihQqIC9SeYgrY554aT7bzjYINFu/IXwkZ3deYeKci85zUskplUCSBjGrlP0wjSn3e+YbzWXc1MXGaqH4BqJb/Xge2p9bw+/6jMwgQIcu0q9/u+k94J4HdBB39brHOMaBbeiCw="
      # DAR_URL
      - secure: "dWwqAu9C8s9opvLUWJr5wfgmSrjKonrTX1IocL4aF5n7RgXM5VnQfgVea86DBqYQcvT6PNsZIvmMjdmpxgit7dkw/RqdHfKLHZE059MFGREj0rHbbe+q+PTJxJtIw8fyUsV1fZ46axzhGeM5ug/9YDX3eXf5m48FElayid1AzYY6mYn2D4+U1dmh+66iEKsb/cRmE3UdoC92dt/VdBxfUKnyC0TI2TexLGybamFQBv/DxC52JYDiaSUwa4BDUu6Mqei//wDwJd73gNIS9lQ9a1FnGM9CBcwrdykaj5Yv8huLfjblfKvZYIl1yMxh0jmhXbJKo+/9zn8aSErXgGG67/1kxyusv4ebu6ivEvIUziKZQS7eE3Cy9xN+5OqHKKzpb1Zuaf+liWsyiqNRLYEsynzB6Rn/RuOg9eMdbaYdjpWby3BG6GF/M999v4ZV5CW3bqxYsq1MErV0CgHytqHDTFEVLvvrqWJTrO78L72xTFV6Jsaxu+lGVo07H+vvOF2JC2432/Kz8PLoG/hTCUyRpBevpv+qt+LVshbTFZKnrCwCLZsWyFA/kwXTcykZl5fF9AjNgyN0oLUH9PGXakNZqBqUVDiwglZYQS3VLt+rgYIcuvSOvsuHnUr+KRT659E6kvU05DJ/ZN9UbWn5yQOyS/FuTJcF28no9JwkdgndxSs="

jobs:
  include:
  - stage: linting
    python: '3.7' # only run once.
    install:
    - pip install -r requirements-dev.txt
    script:
    - pyenv global 3.7.1
    - pre-commit run --all-files
  - stage: system tests
    os: windows
    language: shell       # 'language: python' is an error on Travis CI Windows
    before_install:
      - choco install python --version 3.8.2
      - python -m pip install --upgrade pip
    env: PATH=/c/Python38:/c/Python38/Scripts:$PATH
    # use install: from global test stage, since system tests are
    # also handled via tox
    script:
      - tox -e system_tests
    deploy:
      - provider: releases
        skip_cleanup: true
        api_key:
          # API key for a machine user specifically created for this task:
          # https://github.com/dar-sdk-machine-user
          secure: "m0kXSf53vJY95nb7lrM4N4KTiSmNuSoHfS3swxhjuoEdCPuaYHkpkHjPYH6ZNIjBbFEMGw4YENEcUdyzlshPe/WIX5IQ1LjFTZ1U9wP8Iup0VNW9NAHn32Q9oRUFKdD5IeCtjvQwGdVZbAoJM7+IwX19qqhgkPf1VEPPcq3zW+J/aZNg1ayfH+79x60vybapeG7a8QNvxNATrHaO07+xuWIoDaSKZA0ggDn2zxdaDGk/1SJRZsu67YA0DqFAYB8CtspgewJg7MIrLQcHps9yq+vp1sPHiWy9SH87CDyG9+NMXBb2rnvsmRwxXI659wFOQqMWmCgSs/L3IMPBCGziSqgw7MG5hLVpyrmExINuag2yricm0RDPYVxnJKBz3a7J4pl1zudpdfudich8WDinJk7TJHR3tTgIFx1ASmA20RiY22NUvHWpRL88jNJn5LXDyOaT5bT7c6i9VwxpUq234DXLQ9iUMrbs5P576x/Px71dfJ8RLv52D4TmwQYVzgRdFeFI/TOvyvIKA4dYfGylpsueIScZTn5G0p9srzqpRT8gr1sOlIsBHjISppeyEG6C3uTuhaP/zu7o+soQtiMHWm7G2/5BpUBz7JwMODMnK1f4B4stQJYo7Kx+KsGPUrkJVst07klya44EYGS7Ik8Dm6YsNhvc0safYxxNK71cqGY="
        file: "system_test_results/traceability.html"
        on:
          tags: true
          condition:  $TRAVIS_TAG =~ ^rel/.*$
  - stage: test
    name: "Python: 3.5 on Linux"
    python: "3.5"
    env: TOXENV=py35-cov
  - stage: test
    name: "Python: 3.6 on Linux"
    python: "3.6"
    env: TOXENV=py36-cov
  - stage: test
    name: "Python: 3.7 on Linux"
    python: "3.7"
    env: TOXENV=py37-cov
  - stage: test
    name: "Python: 3.8 on Linux"
    python: "3.8"
    env: TOXENV=py38-cov
  - stage: test
    name: "Python: pypy3 on Linux"
    python: "pypy3"
    env: TOXENV=pypy3-cov
  - stage: test
    name: "Python: 3.8 on Windows"
    # https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems
    os: windows
    language: shell       # 'language: python' is an error on Travis CI Windows
    before_install:
      - choco install python --version 3.8.2
      - python -m pip install --upgrade pip
    env:
      - PATH=/c/Python38:/c/Python38/Scripts:$PATH
      - TOXENV=py38-cov
  - stage: test
    name: "Python: 3.7.4 on macOS"
    os: osx
    osx_image: xcode11.2  # Python 3.7.4 running on macOS 10.14.4
    language: shell       # 'language: python' is an error on Travis CI macOS
    env: TOXENV=py37-cov
  - stage: deploy
    python: '3.7' # only run once
    install: skip
    script: skip
    deploy:
      - provider: pypi
        username: __token__
        distributions: "sdist bdist_wheel"
        password:
          secure: "Yo1GgXnDX8br7Gwy7IbIbTowfbuATV8hwMoWeQEfXb/rkPxJuElbGDb6xEy19E3qojxMbeY2Lm5ahyRXBcQmekyzG4/xa4aLqxa08TEYbH/QQi3T7pFaIpBdPwHE3e3dsKZIFJwFwPymjIBZGC79CQkkD2g2+9GvSSJVkc5OMY/q1rVeWeKxbNmLiSu9kIIusBt1nkmrctLaNNN6fRvjII61bxkujpmBjWGZcNmcVHqxXqEVplfAOhBymalrhl6ABtlzKxLoBWJchqILLsVGoIhHIcUFkA7PyH90UfR5k2mWh7W5kh44vbY4F/OV2Dr875RNc/BYfnNe/RofxtIg1B9Z5JLVpGXsUhfWBqDcymym+ugTdYwEL2D4S2cWEK5sSur+cb/Ib/CAwYUaVf6eWJERzsPKs+5bfHHpkphDUIs7Rp6Mf5bkPgiUgbyWQ0Wdx5a7WXqwHCVpskCDreCF54X4FQuHeSxXrOVQ1GnknpTm5ZCJhuB5ged1a6BmhzF4LbhalHZjmYqy37j+jCLAa8QrpoUkhvPrSKyUQVHnj8P8yw2jydHDdyuWoibwL+rbrHHeX66QreV/utBODfbx2j3tMzkAU8QqKsmP9hWnHFx5Lz6Dl/m8MniKbs7B3vMG3MCJsPz2nawHC/wlDeRqTTARZ+Fpc7VHzj2/ra8Egos="
        on:
          # Limitation on branches is done in the "stages" section, so if
          # the stage is executed, we always want to deploy
          all_branches: true